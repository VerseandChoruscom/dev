<script>
        // Ensure song titles match your master list (Formatted slugs for file paths)
        function getSongSlug(title) { 
            return title.toLowerCase().trim().replace(/[^\w\s-]/g, '').replace(/\s+/g, '-'); 
        }

        // DYNAMIC RENDERING
        function renderVault(data) {
            const grid = document.getElementById('vault-grid-display');
            grid.innerHTML = data.map(song => `
                <div class="song-card shadow-xl">
                    <img src="/assets/covers/${getSongSlug(song.title)}-cover-art.jpg" 
                         onerror="this.src='https://via.placeholder.com/300x300/111/D4AF37?text=${song.title}'" 
                         class="w-full h-48 object-cover rounded-lg mb-4 border border-slate-700">
                    <h3 class="metallic-gold-title text-xl mb-1">${song.title}</h3>
                    <p class="text-[10px] text-gray-500 font-bold uppercase mb-4">
                        ${song.genre1} / ${song.genre2} | ${song.moods[0]} | ${song.povs[0]}
                    </p>
                    <p class="text-sm text-slate-300 italic mb-6 line-clamp-3">"${song.description.substring(0, 150)}..."</p>
                    <button class="vault-btn" onclick="openAsset(${song.id})">READ / PLAY ASSETS</button>
                </div>
            `).join('');
        }

        // HARD FILTER PERSISTENCE
        function applyHardFilter(type, value, el) {
            const btns = document.querySelectorAll('.rect-card');
            const isActive = el.classList.contains('active');
            
            // Toggle active state
            btns.forEach(b => b.classList.remove('active'));
            if (!isActive) el.classList.add('active');

            // Apply filter logic
            const filtered = VAULT_DATA.filter(song => {
                if (isActive) return true; // Revert to all if toggled off
                const target = song[type];
                return Array.isArray(target) ? target.includes(value) : target === value;
            });
            renderVault(filtered);
        }

        // MODAL READ / PLAY LOGIC
        async function openAsset(id) {
            const song = VAULT_DATA.find(s => s.id === id);
            const slug = getSongSlug(song.title);
            const modal = document.getElementById('vault-modal-player');
            
            document.getElementById('modal-title').innerText = song.title;
            document.getElementById('modal-audio').src = `/assets/music/${slug}.mp3`;
            document.getElementById('modal-lyrics').innerHTML = `<p class="text-gray-500 italic">Searching vault for ${song.title}.html...</p>`;
            
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden'; // Prevent scroll

            try {
                const response = await fetch(`/assets/lyrics/${slug}.html`);
                const html = await response.text();
                // We inject a clean Dossier summary before the lyrics
                document.getElementById('modal-lyrics').innerHTML = `
                    <div class="mb-10 p-6 bg-black/40 border-l-4 border-[var(--metallic-gold)]">
                        <h4 class="text-[var(--sunset-orange)] font-black uppercase text-sm mb-2">A&R Narrative Dossier</h4>
                        <p class="text-sm leading-relaxed text-gray-400 mb-6">${song.description}</p>
                        <p class="text-sm text-[var(--metallic-gold)] font-bold italic">${song.bestLyrics}</p>
                    </div>
                    <div class="lyric-body">${html}</div>
                `;
            } catch (e) {
                document.getElementById('modal-lyrics').innerHTML = `<p class="text-red-400">Vault Error: Lyric file for "${song.title}" not found in /assets/lyrics/.</p>`;
            }
        }

        function closeModal() {
            document.getElementById('vault-modal-player').style.display = 'none';
            document.getElementById('modal-audio').pause();
            document.body.style.overflow = 'auto';
        }

        // GLOBAL SEARCH & DROPDOWNS
        function runFilters() {
            const query = document.getElementById('vault-search').value.toLowerCase();
            const genre = document.getElementById('genre-pull').value;
            const mood = document.getElementById('mood-pull').value;
            const style = document.getElementById('subgenre-pull').value;

            const filtered = VAULT_DATA.filter(s => {
                const searchStr = `${s.title} ${s.description} ${s.hashtags.join(' ')} ${s.seoKeywords.join(' ')}`.toLowerCase();
                const matchesSearch = !query || searchStr.includes(query);
                const matchesGenre = !genre || (s.genre1 === genre || s.genre2 === genre);
                const matchesMood = !mood || s.moods.includes(mood);
                const matchesStyle = !style || s.subGenre === style;
                
                return matchesSearch && matchesGenre && matchesMood && matchesStyle;
            });
            renderVault(filtered);
        }

        function populateDropdowns() {
            const genres = [...new Set(VAULT_DATA.flatMap(s => [s.genre1, s.genre2]))].sort();
            const moods = [...new Set(VAULT_DATA.flatMap(s => s.moods))].sort();
            const styles = [...new Set(VAULT_DATA.map(s => s.subGenre))].sort();

            const fill = (id, items) => {
                const el = document.getElementById(id);
                items.forEach(item => {
                    if(!item) return;
                    const opt = document.createElement('option');
                    opt.value = item; opt.innerText = item.toUpperCase();
                    el.appendChild(opt);
                });
            };
            fill('genre-pull', genres);
            fill('mood-pull', moods);
            fill('subgenre-pull', styles);
        }

        function resetFilters() {
            document.getElementById('vault-search').value = '';
            document.querySelectorAll('select').forEach(s => s.selectedIndex = 0);
            document.querySelectorAll('.rect-card').forEach(b => b.classList.remove('active'));
            renderVault(VAULT_DATA);
        }

        window.onload = () => {
            populateDropdowns();
            renderVault(VAULT_DATA);
        };
    </script>
</body>
</html>
